# Mochi API æ¥å£æ–‡æ¡£

## æ¦‚è¿°

- **Base URL**: `http://localhost:{port}`ï¼ˆé»˜è®¤ç«¯å£ 2026ï¼‰
- **Content-Type**: `application/json; charset=utf-8`
- **é”™è¯¯å“åº”æ ¼å¼**ï¼ˆé 2xx æ—¶ï¼‰: `{"error": "é”™è¯¯ä¿¡æ¯"}`

---

## è®¤è¯è¯´æ˜

éƒ¨åˆ†æ¥å£éœ€è¦é‰´æƒï¼Œåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ï¼š

```
Authorization: Bearer <token>
```

ç™»å½•æˆåŠŸåè¿”å›çš„ `token` å­—æ®µå³ä¸ºæ‰€éœ€ tokenã€‚

---

## 1. ç”¨æˆ·è®¤è¯

### 1.1 æ³¨å†Œ

**POST** `/user/register`

**è¯·æ±‚ä½“**

```json
{
  "username": "ç”¨æˆ·å",
  "password": "å¯†ç "
}
```

| å­—æ®µ     | ç±»å‹   | å¿…å¡« | è¯´æ˜     |
|----------|--------|------|----------|
| username | string | æ˜¯   | ç”¨æˆ·å   |
| password | string | æ˜¯   | å¯†ç      |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success"
}
```

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                             |
|--------|----------------------------------|
| 400    | invalid body / username and password required / ç”¨æˆ·åå·²æ³¨å†Œ / å¯†ç éœ€åŒ…å«æ•°å­—ã€å°å†™å­—æ¯ã€å¤§å†™å­—æ¯ |
| 403    | æ³¨å†Œå·²å…³é—­                       |
| 405    | method not allowed               |
| 500    | å†…éƒ¨é”™è¯¯                         |

---

### 1.2 ç™»å½•

**POST** `/user/login`

**è¯·æ±‚ä½“**

```json
{
  "username": "ç”¨æˆ·å",
  "password": "å¯†ç "
}
```

| å­—æ®µ     | ç±»å‹   | å¿…å¡« | è¯´æ˜     |
|----------|--------|------|----------|
| username | string | æ˜¯   | ç”¨æˆ·å   |
| password | string | æ˜¯   | å¯†ç      |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "token": "ç™»å½•æˆåŠŸåè¿”å›çš„ tokenï¼Œç”¨äºåç»­é‰´æƒ",
    "expire": 604800,
    "clientHash": ""
  }
}
```

| å­—æ®µ       | ç±»å‹   | è¯´æ˜                          |
|------------|--------|-------------------------------|
| token      | string | é‰´æƒ tokenï¼Œéœ€åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦  |
| expire     | int    | è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 7 å¤©     |
| clientHash | string | å¯é€‰ï¼Œå®¢æˆ·ç«¯å“ˆå¸Œ              |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                             |
|--------|----------------------------------|
| 400    | invalid body / username and password required |
| 401    | ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯                 |
| 405    | method not allowed               |
| 500    | å†…éƒ¨é”™è¯¯                         |

---

### 1.3 ç”¨æˆ·ç»Ÿè®¡ï¼ˆéœ€é‰´æƒï¼‰

ç”¨æˆ·ç»Ÿè®¡ï¼ˆç´¯è®¡ç™»å½•æ¬¡æ•°ã€ç´¯è®¡ä½¿ç”¨æ—¶é•¿ã€æœ€è¿‘ç™»å½•æ—¶é—´ï¼‰çš„ **å¢æ”¹å®Œå…¨ç”±æœ¬å°èŠ‚æ¥å£å®ç°**ï¼Œç™»å½•æ¥å£ `/user/login` ä¸ä¼šè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ã€‚å‰ç«¯åœ¨ç™»å½•æˆåŠŸåéœ€è°ƒç”¨ã€Œä¸ŠæŠ¥ç™»å½•ã€æ¥å£è®°å½•æœ¬æ¬¡ç™»å½•ã€‚

ä»¥ä¸‹æ¥å£éœ€åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ï¼š`Authorization: Bearer <token>`ã€‚

#### 1.3.1 è·å–ç”¨æˆ·ç»Ÿè®¡

**GET** `/user/stats`

è¿”å›å½“å‰ç”¨æˆ·çš„ç´¯è®¡ç™»å½•æ¬¡æ•°ã€ç´¯è®¡ä½¿ç”¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ã€æœ€è¿‘ä¸€æ¬¡ç™»å½•æ—¶é—´ï¼Œç”¨äºå‰ç«¯å±•ç¤ºã€‚

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "login_count": 10,
    "usage_minutes": 120,
    "last_login_at": "2026-02-02T10:00:00+08:00"
  }
}
```

| å­—æ®µ          | ç±»å‹    | è¯´æ˜                     |
|---------------|---------|--------------------------|
| login_count   | int     | ç´¯è®¡ç™»å½•æ¬¡æ•°             |
| usage_minutes | int     | ç´¯è®¡ä½¿ç”¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰     |
| last_login_at | string  | æœ€è¿‘ä¸€æ¬¡ç™»å½•æ—¶é—´ï¼ˆISO8601ï¼‰ï¼Œå¯ä¸º null |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜             |
|--------|------------------|
| 401    | missing authorization / unauthorized |
| 404    | user not found   |
| 500    | å†…éƒ¨é”™è¯¯         |

#### 1.3.2 ä¸ŠæŠ¥ç™»å½•ï¼ˆåŸ‹ç‚¹ï¼‰

**POST** `/user/stats/login`

å‰ç«¯åŸ‹ç‚¹ä¸ŠæŠ¥æœ¬æ¬¡ç™»å½•ã€‚æœåŠ¡ç«¯å°†å½“å‰ç”¨æˆ·çš„ç´¯è®¡ç™»å½•æ¬¡æ•° +1ï¼Œå¹¶å°†æœ€è¿‘ç™»å½•æ—¶é—´æ›´æ–°ä¸ºå½“å‰æ—¶é—´ã€‚**å»ºè®®åœ¨è°ƒç”¨ `/user/login` æˆåŠŸå¹¶æ‹¿åˆ° token åç«‹å³è°ƒç”¨æœ¬æ¥å£**ï¼ˆè¯·æ±‚å¤´æºå¸¦è¯¥ tokenï¼‰ã€‚

**è¯·æ±‚ä½“**ï¼šæ— ï¼Œæˆ–ç©ºå¯¹è±¡ `{}`ã€‚

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success"
}
```

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜             |
|--------|------------------|
| 401    | missing authorization / unauthorized |
| 405    | method not allowed |
| 500    | å†…éƒ¨é”™è¯¯         |

#### 1.3.3 ä¸ŠæŠ¥ä½¿ç”¨æ—¶é•¿ï¼ˆåŸ‹ç‚¹ï¼‰

**POST** `/user/stats/usage`

å‰ç«¯åŸ‹ç‚¹ä¸ŠæŠ¥æœ¬æ®µä½¿ç”¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼ŒæœåŠ¡ç«¯ä¼šç´¯åŠ åˆ°è¯¥ç”¨æˆ·çš„ç´¯è®¡ä½¿ç”¨æ—¶é•¿ã€‚å»ºè®®åœ¨åº”ç”¨åˆ‡åˆ°åå°æˆ–å®šæ—¶ï¼ˆå¦‚æ¯ 5 åˆ†é’Ÿï¼‰ä¸ŠæŠ¥ä¸€æ¬¡ã€‚

**è¯·æ±‚ä½“**

```json
{
  "minutes": 5
}
```

| å­—æ®µ    | ç±»å‹ | å¿…å¡« | è¯´æ˜                 |
|---------|------|------|----------------------|
| minutes | int  | æ˜¯   | æœ¬æ®µä½¿ç”¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success"
}
```

**è¯´æ˜**ï¼šè‹¥ `minutes` â‰¤ 0ï¼Œæ¥å£ç›´æ¥è¿”å›æˆåŠŸï¼Œä¸æ›´æ–°æ•°æ®ã€‚

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜             |
|--------|------------------|
| 400    | invalid body     |
| 401    | missing authorization / unauthorized |
| 405    | method not allowed |
| 500    | å†…éƒ¨é”™è¯¯         |

---

## 2. æƒ…ç»ªç¢ç‰‡ï¼ˆEmotion Blobsï¼‰

ä»¥ä¸‹æ¥å£å‡éœ€é‰´æƒï¼š`Authorization: Bearer <token>`ã€‚

### 2.1 åˆ›å»ºæƒ…ç»ªç¢ç‰‡

**POST** `/emotion-blobs`

**è¯·æ±‚ä½“**

```json
{
  "content": "æƒ…ç»ªå†…å®¹æ–‡æœ¬",
  "source": "æ‰‹åŠ¨è®°å½•"
}
```

| å­—æ®µ    | ç±»å‹   | å¿…å¡« | è¯´æ˜                                                                 |
|---------|--------|------|----------------------------------------------------------------------|
| content | string | æ˜¯   | æƒ…ç»ªå†…å®¹æ–‡æœ¬                                                         |
| source  | string | å¦   | æ¥æºï¼Œå¯é€‰ï¼š`æ‰‹åŠ¨è®°å½•`ã€`å¯¹è¯æå–`ã€`å½•éŸ³è®°å½•`ã€‚å½“å‰æ ‡é¢˜/åˆ†ç±»ç”Ÿæˆä»…æ”¯æŒ `æ‰‹åŠ¨è®°å½•` |

**æˆåŠŸå“åº”**ï¼ˆ201ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": "uuid",
    "user_id": 1,
    "title": "æƒ…ç»ªå…³é”®è¯æ ‡é¢˜",
    "created_at": "2026-02-02T10:00:00Z",
    "content": "æƒ…ç»ªå†…å®¹æ–‡æœ¬",
    "source": "æ‰‹åŠ¨è®°å½•",
    "category": "æ„ˆç–—è“/ç»¿",
    "color": "#22D3EE",
    "is_discussed": false
  }
}
```

| å­—æ®µ         | ç±»å‹    | è¯´æ˜                                                         |
|--------------|---------|--------------------------------------------------------------|
| id           | string  | æƒ…ç»ªç¢ç‰‡ ID                                                  |
| user_id      | int64   | ç”¨æˆ· ID                                                      |
| title        | string  | æ ‡é¢˜ï¼ˆç”± LLM ç”Ÿæˆçš„æƒ…ç»ªå…³é”®è¯ï¼Œæœ€å¤š 15 å­—ï¼‰                   |
| created_at   | string  | åˆ›å»ºæ—¶é—´ï¼ŒRFC3339                                            |
| content      | string  | åŸå§‹å†…å®¹                                                     |
| source       | string  | æ¥æºï¼šæ‰‹åŠ¨è®°å½• / å¯¹è¯æå– / å½•éŸ³è®°å½•                          |
| category     | string  | æƒ…ç»ªåˆ†ç±»ï¼šæ„ˆç–—è“/ç»¿ã€èƒ½é‡æ©™/é»„ã€æ²‰æ€ç´«/ç°ã€æ³¢åŠ¨ç²‰/çº¢           |
| color        | string  | è¯¥ç±»åˆ«ä¸‹çš„éšæœºè‰²å€¼ï¼ˆå¦‚ #22D3EEï¼‰                              |
| is_discussed | boolean | æ˜¯å¦å·²è®¨è®º                                                   |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                                                             |
|--------|------------------------------------------------------------------|
| 400    | invalid body / content required / source å¿…é¡»ä¸º æ‰‹åŠ¨è®°å½•/å¯¹è¯æå–/å½•éŸ³è®°å½• ä¹‹ä¸€ / è¯¥æ¥æºçš„æ ‡é¢˜/åˆ†ç±»æå–å°šæœªé…ç½® |
| 401    | unauthorized / missing authorization / invalid authorization     |
| 405    | method not allowed                                               |
| 500    | å†…éƒ¨é”™è¯¯ / LLM ç©ºå“åº”ç­‰                                          |

---

### 2.2 è·å–æœ‰ç¢ç‰‡çš„æ—¥æœŸåˆ—è¡¨

**GET** `/emotion-blobs/dates?from={from}&to={to}`

| å‚æ•°  | ç±»å‹   | å¿…å¡« | è¯´æ˜                        |
|-------|--------|------|-----------------------------|
| from  | string | æ˜¯   | èµ·å§‹æ—¥æœŸï¼ŒRFC3339 æ ¼å¼      |
| to    | string | æ˜¯   | ç»“æŸæ—¥æœŸï¼ŒRFC3339 æ ¼å¼      |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": ["2026-02-01T00:00:00Z", "2026-02-02T00:00:00Z"]
}
```

`data` ä¸ºåœ¨ `from`ï½`to` èŒƒå›´å†…æœ‰æƒ…ç»ªç¢ç‰‡çš„æ—¥æœŸåˆ—è¡¨ï¼ˆRFC3339ï¼Œå½“æ—¥ 00:00:00 UTCï¼‰ã€‚

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                                         |
|--------|----------------------------------------------|
| 400    | from and to required (RFC3339) / from: invalid RFC3339 / to: invalid RFC3339 |
| 401    | unauthorized                                 |
| 405    | method not allowed                           |
| 500    | å†…éƒ¨é”™è¯¯                                     |

---

### 2.3 æŒ‰æ—¥æœŸè·å–æƒ…ç»ªç¢ç‰‡åˆ—è¡¨

**GET** `/emotion-blobs?date={date}`

| å‚æ•°  | ç±»å‹   | å¿…å¡« | è¯´æ˜                   |
|-------|--------|------|------------------------|
| date  | string | æ˜¯   | æŸ¥è¯¢æ—¥æœŸï¼ŒRFC3339 æ ¼å¼ |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "blobs": [
      {
        "id": "uuid",
        "user_id": 1,
        "title": "æƒ…ç»ªå…³é”®è¯",
        "created_at": "2026-02-02T10:00:00Z",
        "content": "å†…å®¹",
        "source": "æ‰‹åŠ¨è®°å½•",
        "category": "æ„ˆç–—è“/ç»¿",
        "color": "#22D3EE",
        "is_discussed": false
      }
    ],
    "dailySummary": {
      "emotions": "å½“æ—¥æƒ…ç»ªæ€»ç»“æ–‡æœ¬",
      "events": "å½“æ—¥äº‹ä»¶æ€»ç»“æ–‡æœ¬"
    }
  }
}
```

| å­—æ®µ           | ç±»å‹   | è¯´æ˜                                           |
|----------------|--------|------------------------------------------------|
| blobs          | array  | è¯¥æ—¥æœŸçš„æƒ…ç»ªç¢ç‰‡åˆ—è¡¨ï¼Œç»“æ„åŒ 2.1 åˆ›å»ºå“åº”       |
| dailySummary   | object | å¯é€‰ï¼Œå½“æ—¥æƒ…ç»ªç¢ç‰‡æ€»ç»“ï¼ˆå‡Œæ™¨ 4 ç‚¹å®šæ—¶ç”Ÿæˆï¼‰     |
| dailySummary.emotions | string | æƒ…ç»ªæ€»ç»“                                     |
| dailySummary.events   | string | äº‹ä»¶æ€»ç»“                                     |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                             |
|--------|----------------------------------|
| 400    | date required (RFC3339) / date: invalid RFC3339 |
| 401    | unauthorized                     |
| 405    | method not allowed               |
| 500    | å†…éƒ¨é”™è¯¯                         |

---

### 2.4 è·å–æƒ…ç»ªè¯„ä¼°

**GET** `/emotion-blobs/eval?date={date}`

æ ¹æ®**æŒ‡å®šæ—¥æœŸ**çš„æƒ…ç»ªç¢ç‰‡è¿”å›æƒ…ç»ªè¯„ä¼°ç»“æœã€‚æœåŠ¡ç«¯ä¼šå…ˆæ£€æŸ¥è¯¥æ—¥æœŸä¸‹ã€Œæœ€æ–°æƒ…ç»ªç¢ç‰‡ idã€ä¸ã€Œè¯¥æ—¥æœŸä¸‹å·²å­˜æœ€æ–°æƒ…ç»ªè¯„ä¼°å¯¹åº”çš„æƒ…ç»ªç¢ç‰‡ idã€æ˜¯å¦ä¸€è‡´ï¼šä¸€è‡´åˆ™ç›´æ¥è¿”å›å·²å­˜ç»“æœï¼›å¦åˆ™ï¼ˆæˆ–è¯¥æ—¥æœŸå°šæ— æƒ…ç»ªè¯„ä¼°ï¼‰åˆ™è°ƒç”¨ LLM ç”Ÿæˆæ–°è¯„ä¼°å¹¶è½åº“åè¿”å›ã€‚

| å‚æ•°  | ç±»å‹   | å¿…å¡« | è¯´æ˜                   |
|-------|--------|------|------------------------|
| date  | string | æ˜¯   | ç›®æ ‡æ—¥æœŸï¼ŒRFC3339 æ ¼å¼ |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "mood_category": "æ²»æ„ˆ/æ¸…æ–°",
    "emoji": "ğŸ˜Œ",
    "reason": "ä»Šæ—¥è®°å½•è¾ƒå°‘",
    "status_text": "æ¯ä¸€å¤©éƒ½å€¼å¾—è¢«æ¸©æŸ”å¯¹å¾…"
  }
}
```

| å­—æ®µ           | ç±»å‹   | è¯´æ˜                                                         |
|----------------|--------|--------------------------------------------------------------|
| mood_category  | string | æƒ…ç»ªåˆ†ç±»ï¼šæ²»æ„ˆ/æ¸…æ–°ã€ç§¯æ/èƒ½é‡ã€æ²‰æ€/ç–²æƒ«ã€æ•æ„Ÿ/æ³¢åŠ¨ å››ç±»ä¹‹ä¸€ |
| emoji          | string | å¯¹åº”ç±»åˆ«çš„ emoji                                             |
| reason         | string | ç®€çŸ­ç†ç”±ï¼Œä¸è¶…è¿‡ 20 å­—                                       |
| status_text    | string | 12ï½22 å­—çš„æ¸©æš–é™ªä¼´æ–‡æ¡ˆï¼Œä¸å«å¼•å·ä¸è¡¨æƒ…ç¬¦å·                  |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                                             |
|--------|--------------------------------------------------|
| 400    | date required (RFC3339) / date: invalid RFC3339   |
| 401    | unauthorized                                     |
| 405    | method not allowed                               |
| 500    | å†…éƒ¨é”™è¯¯ / LLM æœªè¿”å›æœ‰æ•ˆå†…å®¹                     |
| 503    | æœªé…ç½®å¯ç”¨çš„æƒ…ç»ªè¯„ä¼°æç¤ºè¯ï¼ˆæç¤ºè¯è¡¨æ—  is_enabled=trueï¼‰ |

---

## 3. èŠå¤©ï¼ˆChatï¼‰

ä»¥ä¸‹æ¥å£å‡éœ€é‰´æƒï¼š`Authorization: Bearer <token>`ã€‚

### 3.1 åˆ›å»ºèŠå¤©ä¼šè¯

**POST** `/chat/sessions`

**è¯·æ±‚ä½“**ï¼šæ— ï¼ˆæˆ–ç©ºå¯¹è±¡ `{}`ï¼‰

**æˆåŠŸå“åº”**ï¼ˆ201ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "id": "session-uuid",
    "user_id": 1,
    "created_at": "2026-02-02T10:00:00Z",
    "updated_at": "2026-02-02T10:00:00Z",
    "is_ended": false,
    "emotion_blob_ids": [],
    "end_card_mode": "",
    "end_card_text": ""
  }
}
```

| å­—æ®µ             | ç±»å‹   | è¯´æ˜                                    |
|------------------|--------|-----------------------------------------|
| id               | string | ä¼šè¯ ID                                 |
| user_id          | int64  | ç”¨æˆ· ID                                 |
| created_at       | string | åˆ›å»ºæ—¶é—´ï¼ŒRFC3339                       |
| updated_at       | string | æ›´æ–°æ—¶é—´ï¼ŒRFC3339                       |
| is_ended         | bool   | æ˜¯å¦å·²ç»“æŸ                              |
| emotion_blob_ids | array  | å…³è”çš„æƒ…ç»ªç¢ç‰‡ ID åˆ—è¡¨                  |
| end_card_mode    | string | ç»“æŸæ—¶çš„ End Card ç±»å‹ï¼šTODO / NUDGEï¼Œæœªç»“æŸæ—¶ä¸ºç©º |
| end_card_text    | string | ç»“æŸæ—¶çš„ End Card æ–‡æ¡ˆï¼Œæœªç»“æŸæ—¶ä¸ºç©º     |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜             |
|--------|------------------|
| 401    | unauthorized     |
| 405    | method not allowed |
| 500    | å†…éƒ¨é”™è¯¯         |

---

### 3.2 åˆ†é¡µè·å–èŠå¤©ä¼šè¯åˆ—è¡¨

**GET** `/chat/sessions?page={page}`

| å‚æ•°  | ç±»å‹   | å¿…å¡« | è¯´æ˜                        |
|-------|--------|------|-----------------------------|
| page  | int    | å¦   | é¡µç ï¼Œä» 1 å¼€å§‹ï¼Œé»˜è®¤ 1      |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "sessions": [
      {
        "id": "session-uuid",
        "user_id": 1,
        "created_at": "2026-02-02T10:00:00Z",
        "updated_at": "2026-02-02T10:00:00Z",
        "is_ended": false,
        "emotion_blob_ids": [],
        "end_card_mode": "TODO",
        "end_card_text": "æ™šå®‰ï¼Œæ˜å¤©æ—©ç‚¹ç¡ã€‚"
      }
    ],
    "total": 25,
    "page": 1,
    "pageSize": 10
  }
}
```

| å­—æ®µ       | ç±»å‹   | è¯´æ˜                              |
|------------|--------|-----------------------------------|
| sessions   | array  | å½“å‰é¡µçš„ä¼šè¯åˆ—è¡¨ï¼Œç»“æ„åŒ 3.1 åˆ›å»ºå“åº” |
| total      | int64  | å½“å‰ç”¨æˆ·ä¼šè¯æ€»æ•°                  |
| page       | int    | å½“å‰é¡µç                           |
| pageSize   | int    | æ¯é¡µæ¡æ•°ï¼Œå›ºå®š 10                 |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜             |
|--------|------------------|
| 401    | unauthorized     |
| 405    | method not allowed |
| 500    | å†…éƒ¨é”™è¯¯         |

---

### 3.3 ç»“æŸä¼šè¯å¹¶ç”Ÿæˆ End Card

**POST** `/chat/sessions/{sessionId}/end`

ç»“æŸæŒ‡å®šä¼šè¯ï¼šå°†ä¼šè¯æ ‡è®°ä¸ºå·²ç»“æŸï¼Œå¹¶æ ¹æ®æœ¬æ¬¡å¯¹è¯ä¸Šä¸‹æ–‡è°ƒç”¨æ¨¡å‹ç”Ÿæˆä¸€æ¡ End Cardï¼ˆTODO æˆ– NUDGE ç±»å‹åŠå¯¹åº”æ–‡æ¡ˆï¼‰ï¼Œå†™å…¥ä¼šè¯çš„ `end_card_mode`ã€`end_card_text` å¹¶è¿”å›ã€‚

| è·¯å¾„å‚æ•°   | ç±»å‹   | è¯´æ˜        |
|------------|--------|-------------|
| sessionId  | string | èŠå¤©ä¼šè¯ ID |

**è¯·æ±‚ä½“**ï¼šæ— ï¼ˆæˆ–ç©ºå¯¹è±¡ `{}`ï¼‰

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "mode": "TODO",
    "text": "æ™šå®‰ï¼Œæ˜å¤©æ—©ç‚¹ç¡ã€‚"
  }
}
```

| å­—æ®µ | ç±»å‹   | è¯´æ˜                                      |
|------|--------|-------------------------------------------|
| mode | string | End Card ç±»å‹ï¼š`TODO` æˆ– `NUDGE`          |
| text | string | End Card æ–‡æ¡ˆï¼ˆä¾¿ç­¾/è½»æé†’ï¼Œâ‰¤20 æˆ– â‰¤32 å­—ï¼‰ |

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                     |
|--------|--------------------------|
| 400    | sessionId ç¼ºå¤±           |
| 401    | unauthorized             |
| 403    | æ— æƒæ“ä½œè¯¥ä¼šè¯           |
| 404    | ä¼šè¯ä¸å­˜åœ¨               |
| 405    | method not allowed       |
| 500    | å†…éƒ¨é”™è¯¯ï¼ˆå¦‚ä¼šè¯å·²ç»“æŸã€æ¨¡å‹/æç¤ºè¯æœåŠ¡å¼‚å¸¸ç­‰ï¼‰ |

---

### 3.4 æ ¹æ®ä¼šè¯ ID è·å–æ¶ˆæ¯åˆ—è¡¨

**GET** `/chat/sessions/{sessionId}/messages`

| è·¯å¾„å‚æ•°   | ç±»å‹   | è¯´æ˜        |
|------------|--------|-------------|
| sessionId  | string | èŠå¤©ä¼šè¯ ID |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

```json
{
  "code": 0,
  "msg": "success",
  "data": [
    {
      "id": "msg-uuid",
      "chat_session_id": "session-uuid",
      "type": "user",
      "content": "ç”¨æˆ·å‘é€çš„åŸæ–‡",
      "created_at": "2026-02-02T12:00:00Z"
    },
    {
      "id": "msg-uuid",
      "chat_session_id": "session-uuid",
      "type": "ai",
      "content": "æ¨¡å‹å›å¤å†…å®¹",
      "created_at": "2026-02-02T12:00:01Z"
    }
  ]
}
```

| å­—æ®µ           | ç±»å‹   | è¯´æ˜                                    |
|----------------|--------|-----------------------------------------|
| id             | string | æ¶ˆæ¯ ID                                 |
| chat_session_id| string | æ‰€å±ä¼šè¯ ID                             |
| type           | string | æ¶ˆæ¯ç±»å‹ï¼š`user` / `ai`                 |
| content        | string | æ¶ˆæ¯å†…å®¹ï¼ˆuser ä¸ºåŸæ–‡ï¼Œai ä¸ºæ¨¡å‹å›å¤ï¼‰   |
| created_at     | string | åˆ›å»ºæ—¶é—´ï¼ŒRFC3339                       |

**è¯´æ˜**ï¼šæ¥å£ä¸è¿”å› `prompt` å­—æ®µï¼ˆä»…å†…éƒ¨ç”¨äºå‘ç»™æ¨¡å‹çš„å®Œæ•´æç¤ºï¼‰ã€‚

**é”™è¯¯å“åº”**

| çŠ¶æ€ç  | è¯´æ˜                             |
|--------|----------------------------------|
| 400    | sessionId required              |
| 401    | unauthorized                     |
| 403    | forbiddenï¼ˆéä¼šè¯æ‹¥æœ‰è€…ï¼‰        |
| 404    | session not found                |
| 405    | method not allowed               |
| 500    | å†…éƒ¨é”™è¯¯                         |

---

### 3.5 å‘é€æ¶ˆæ¯ï¼ˆæµå¼ SSEï¼‰

**POST** `/chat/messages`

**è¯·æ±‚ä½“**

```json
{
  "sessionId": "session-uuid",
  "message": "ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯",
  "emotionBlobIds": ["blob-id-1", "blob-id-2"]
}
```

| å­—æ®µ            | ç±»å‹   | å¿…å¡« | è¯´æ˜                           |
|-----------------|--------|------|--------------------------------|
| sessionId       | string | æ˜¯   | èŠå¤©ä¼šè¯ ID                    |
| message         | string | å¦   | ç”¨æˆ·æ¶ˆæ¯æ–‡æœ¬ï¼›å½“ `emotionBlobIds` ä¸ºç©ºæ—¶å¿…å¡« |
| emotionBlobIds  | array  | å¦   | å…³è”çš„æƒ…ç»ªç¢ç‰‡ IDï¼Œç”¨äºä¸Šä¸‹æ–‡ï¼›å½“ `message` ä¸ºç©ºæ—¶è‡³å°‘ä¼  1 ä¸ª |

**æˆåŠŸå“åº”**ï¼ˆ200ï¼‰

æµå¼è¿”å›ï¼Œ`Content-Type: text/event-stream`ï¼ŒSSE äº‹ä»¶æ ¼å¼ï¼š

```
data: {"content":"ä¸€æ®µæ–‡æœ¬å†…å®¹"}

data: {"content":"ä¸‹ä¸€æ®µæ–‡æœ¬"}
```

å®¢æˆ·ç«¯è§£æ `data:` åçš„ JSONï¼Œå– `content` å­—æ®µæ‹¼æ¥åˆ°å®Œæ•´å›å¤ã€‚

**è¡¥å……è¯´æ˜**

- **é»˜è®¤ç”¨æˆ·æ–‡æ¡ˆ**ï¼šå½“å®¢æˆ·ç«¯ `message` ä¸ºç©ºã€ä¸” `emotionBlobIds` è‡³å°‘åŒ…å« 1 ä¸ªå…ƒç´ æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šå°†æœ¬è½®ç”¨æˆ·æ¶ˆæ¯çš„ `content` ç½®ä¸º `æˆ‘æƒ³èŠèŠ{æƒ…ç»ªç¢ç‰‡æ ‡é¢˜}è¿™ä»¶äº‹`ï¼ˆæ ‡é¢˜å–å…³è”ç¢ç‰‡çš„ `title`ï¼Œè‹¥å–ä¸åˆ°åˆ™é™çº§ä¸ºé€šç”¨æ–‡æ¡ˆï¼‰ã€‚
- **æ ‡è®°å·²è®¨è®º**ï¼šå½“æœ¬æ¬¡è¯·æ±‚æºå¸¦ `emotionBlobIds` ä¸”æ¶ˆæ¯å¯¹æˆåŠŸè½åº“åï¼ŒæœåŠ¡ç«¯ä¼šå°†å¯¹åº”æƒ…ç»ªç¢ç‰‡æ ‡è®°ä¸º `is_discussed=true`ï¼ˆbest-effortï¼›å¤±è´¥ä¸å½±å“ä¸»æµç¨‹è¿”å›ï¼‰ã€‚

**é”™è¯¯å“åº”**ï¼ˆåœ¨æµå¼€å§‹å‰è¿”å›ï¼‰

| çŠ¶æ€ç  | è¯´æ˜                             |
|--------|----------------------------------|
| 400    | invalid body / sessionId required / message requiredï¼ˆå½“ emotionBlobIds ä¸ºç©ºæ—¶ï¼‰ |
| 401    | unauthorized                     |
| 403    | forbiddenï¼ˆéä¼šè¯æ‹¥æœ‰è€…ï¼‰         |
| 404    | session not found                |
| 405    | method not allowed               |
| 500    | å†…éƒ¨é”™è¯¯ / streaming not supported |

**è¯´æ˜**ï¼šæµå¼ä¼ è¾“å¼€å§‹åè‹¥å‘ç”Ÿé”™è¯¯ï¼Œä»…ä¼šä¸­æ–­æµï¼Œä¸ä¼šå†è¿”å›æ–°çš„ HTTP é”™è¯¯ä½“ã€‚

---

## é™„å½•

### æƒ…ç»ªç¢ç‰‡æ¥æºï¼ˆsourceï¼‰

| å€¼       | è¯´æ˜     |
|----------|----------|
| æ‰‹åŠ¨è®°å½• | ç”¨æˆ·æ‰‹åŠ¨å½•å…¥ï¼Œæ”¯æŒæ ‡é¢˜/åˆ†ç±» LLM ç”Ÿæˆ |
| å¯¹è¯æå– | ä»å¯¹è¯ä¸­æå–ï¼Œå½“å‰ä¸æ”¯æŒ LLM æ ‡é¢˜/åˆ†ç±» |
| å½•éŸ³è®°å½• | å½•éŸ³è½¬å†™ï¼Œå½“å‰ä¸æ”¯æŒ LLM æ ‡é¢˜/åˆ†ç±»   |

### æƒ…ç»ªç¢ç‰‡åˆ†ç±»ï¼ˆcategoryï¼‰

| å€¼         | è¯´æ˜     |
|------------|----------|
| æ„ˆç–—è“/ç»¿  | æ²»æ„ˆã€å¹³å’Œç±» |
| èƒ½é‡æ©™/é»„  | æ´»åŠ›ã€ç§¯æç±» |
| æ²‰æ€ç´«/ç°  | æ€è€ƒã€å†·é™ç±» |
| æ³¢åŠ¨ç²‰/çº¢  | æ³¢åŠ¨ã€æ¿€çƒˆç±» |

### æ—¥æœŸæ ¼å¼

æ‰€æœ‰æ—¥æœŸå‚æ•°åŠè¿”å›å€¼å‡ä½¿ç”¨ **RFC3339** æ ¼å¼ï¼Œä¾‹å¦‚ï¼š

- `2026-02-02T00:00:00Z`
- `2026-02-02T10:30:00+08:00`

### å®šæ—¶æ¨é€ï¼ˆæå…‰ JPushï¼‰

- **æ‰§è¡Œæ—¶é—´**ï¼šæ¯å¤© 8:00ï¼ˆcron `0 8 * * *`ï¼‰ï¼Œå¯¹**å½“æ—¥**æœ‰æƒ…ç»ªç¢ç‰‡çš„ç”¨æˆ·æ¨é€ä¸€æ¡ã€Œæ¸©æŸ”å”¤é†’ã€é€šçŸ¥ã€‚
- **é…ç½®**ï¼šåœ¨ `config.yaml` ä¸­é…ç½® `jpush.app_key`ã€`jpush.master_secret`ï¼Œæˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ `JPUSH_APP_KEY`ã€`JPUSH_MASTER_SECRET`ã€‚ä¸é…ç½®åˆ™å®šæ—¶ä»»åŠ¡è·³è¿‡æ¨é€ã€‚
- **é€»è¾‘**ï¼šæ¯ä¸ªç”¨æˆ·ä»å½“æ—¥ã€Œæ‰‹åŠ¨è®°å½•ã€ã€Œå½•éŸ³è®°å½•ã€ç±»å‹çš„æƒ…ç»ªç¢ç‰‡ä¸­**éšæœºæŠ½å–ä¸€æ¡**ï¼Œç”¨æ•°æ®åº“ä¸­çš„ `prompt_notification_text` æç¤ºè¯è°ƒç”¨ LLM ç”Ÿæˆä¸€å¥é€šçŸ¥æ–‡æ¡ˆï¼Œå†é€šè¿‡æå…‰ v3 API æŒ‰ç”¨æˆ·æ¨é€ã€‚
- **å®¢æˆ·ç«¯**ï¼šæå…‰æ¨é€éœ€ç”¨**åˆ«å**åŒºåˆ†ç”¨æˆ·ã€‚å®¢æˆ·ç«¯åœ¨ç™»å½•ååº”è°ƒç”¨æå…‰ SDK å°† **alias è®¾ç½®ä¸ºå½“å‰ç”¨æˆ· ID çš„å­—ç¬¦ä¸²**ï¼ˆå¦‚ `"123"`ï¼‰ï¼Œä»¥ä¾¿æœåŠ¡ç«¯æŒ‰ `audience.alias` ç²¾å‡†æ¨é€ç»™å¯¹åº”ç”¨æˆ·ã€‚

**æ¨é€å†…å®¹ï¼ˆJSONï¼‰**

æœåŠ¡ç«¯å‘ç»™æå…‰ v3 çš„è¯·æ±‚ä½“ç»“æ„å¦‚ä¸‹ï¼ˆæ¯ç”¨æˆ·ä¸€æ¡è¯·æ±‚ï¼‰ï¼š

```json
{
  "platform": "all",
  "audience": {
    "alias": ["ç”¨æˆ·IDçš„å­—ç¬¦ä¸²ï¼Œå¦‚ \"123\""]
  },
  "notification": {
    "alert": "ç”Ÿæˆçš„å¼•å¯¼æ–‡æ¡ˆï¼Œ15â€“30 å­— + emojiï¼Œå¦‚ï¼šä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæ¥èŠèŠå§ ğŸŒ¸",
    "android": {
      "extras": {
        "emotion_blob_id": "æœ¬æ¬¡ä½¿ç”¨çš„æƒ…ç»ªç¢ç‰‡ UUIDï¼Œæ— ç¢ç‰‡æ—¶ä¸ºç©ºå­—ç¬¦ä¸²"
      }
    },
    "ios": {
      "extras": {
        "emotion_blob_id": "æœ¬æ¬¡ä½¿ç”¨çš„æƒ…ç»ªç¢ç‰‡ UUIDï¼Œæ— ç¢ç‰‡æ—¶ä¸ºç©ºå­—ç¬¦ä¸²"
      }
    }
  }
}
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `notification.alert` | string | é€šçŸ¥æ å±•ç¤ºçš„æ–‡æ¡ˆï¼Œç”± LLM æ ¹æ®å½“æ—¥æƒ…ç»ªç¢ç‰‡ç”Ÿæˆ |
| `notification.android.extras.emotion_blob_id` | string | æœ¬æ¬¡å…³è”çš„æƒ…ç»ªç¢ç‰‡ IDï¼Œå®¢æˆ·ç«¯å¯æ®æ­¤è·³è½¬è¯¦æƒ…ï¼›æ— ç¢ç‰‡æ—¶ä¸º `""` |
| `notification.ios.extras.emotion_blob_id` | string | åŒä¸Š |

### æç¤ºè¯è¡¨ï¼šå®šæ—¶æ¨é€æ–‡æ¡ˆï¼ˆprompt_notification_textï¼‰

- è¡¨ç»“æ„ï¼š`id`ã€`content`ï¼ˆæç¤ºè¯æ­£æ–‡ï¼‰ã€`is_enabled`ã€`created_at`ã€‚ä»…å…è®¸ä¸€æ¡ `is_enabled = true`ã€‚
- æç¤ºè¯ä¸­å ä½ç¬¦ï¼š`{æƒ…ç»ªç¢ç‰‡çš„label+noteä¿¡æ¯}`ï¼Œè¿è¡Œæ—¶ä¼šè¢«æ›¿æ¢ä¸ºå½“å‰é€‰ä¸­çš„æƒ…ç»ªç¢ç‰‡çš„ labelï¼ˆæ ‡é¢˜ï¼‰ä¸ noteï¼ˆå†…å®¹ï¼‰ä¿¡æ¯ã€‚
- åˆå§‹ content å¯å‚è€ƒä»“åº“å†… `internal/prompts/notification_text.txt`ï¼Œå¤åˆ¶åˆ°æ•°æ®åº“å¹¶è®¾ç½®ä¸€æ¡ `is_enabled = true` åï¼Œå®šæ—¶æ¨é€æ‰ä¼šç”Ÿæ•ˆã€‚
